From 46fc19268d993d410607c5a99b9d9a6f21dff812 Mon Sep 17 00:00:00 2001
From: Aashvij Shenai <a-shenai@ti.com>
Date: Wed, 27 Mar 2024 16:01:57 +0530
Subject: [PATCH] am62ax: Use NOR

Signed-off-by: Aashvij Shenai <a-shenai@ti.com>
---
 arch/arm/dts/k3-am62a-main.dtsi       |  3 +--
 arch/arm/dts/k3-am62a7-sk-u-boot.dtsi |  4 ++++
 arch/arm/dts/k3-am62a7-sk.dts         | 10 +++++-----
 configs/am62ax_evm_a53_defconfig      | 11 +++++++++--
 configs/am62ax_evm_r5_defconfig       | 19 +++++++++++++++++--
 5 files changed, 36 insertions(+), 11 deletions(-)

diff --git a/arch/arm/dts/k3-am62a-main.dtsi b/arch/arm/dts/k3-am62a-main.dtsi
index 41aec3a82e86..63f33a71101f 100644
--- a/arch/arm/dts/k3-am62a-main.dtsi
+++ b/arch/arm/dts/k3-am62a-main.dtsi
@@ -553,7 +553,6 @@
 		#address-cells = <2>;
 		#size-cells = <2>;
 		ranges;
-		status = "disabled";
 
 		ospi0: spi@fc40000 {
 			compatible = "ti,am654-ospi", "cdns,qspi-nor";
@@ -566,7 +565,7 @@
 			clocks = <&k3_clks 75 7>;
 			assigned-clocks = <&k3_clks 75 7>;
 			assigned-clock-parents = <&k3_clks 75 8>;
-			assigned-clock-rates = <166666666>;
+			assigned-clock-rates = <25000000>;
 			power-domains = <&k3_pds 75 TI_SCI_PD_EXCLUSIVE>;
 			#address-cells = <1>;
 			#size-cells = <0>;
diff --git a/arch/arm/dts/k3-am62a7-sk-u-boot.dtsi b/arch/arm/dts/k3-am62a7-sk-u-boot.dtsi
index 090520500570..8de960facff5 100644
--- a/arch/arm/dts/k3-am62a7-sk-u-boot.dtsi
+++ b/arch/arm/dts/k3-am62a7-sk-u-boot.dtsi
@@ -215,6 +215,10 @@
 
 		partitions {
 			bootph-pre-ram;
+
+			partition@3fc0000 {
+				u-boot,dm-spl;
+			};
 		};
 	};
 };
diff --git a/arch/arm/dts/k3-am62a7-sk.dts b/arch/arm/dts/k3-am62a7-sk.dts
index f727b5f82580..6898b412e9d0 100644
--- a/arch/arm/dts/k3-am62a7-sk.dts
+++ b/arch/arm/dts/k3-am62a7-sk.dts
@@ -409,7 +409,7 @@
 	pinctrl-0 = <&ospi0_pins_default>;
 
 	flash@0{
-		compatible = "spi-nand";
+		compatible = "jedec,spi-nor";
 		reg = <0x0>;
 		spi-tx-bus-width = <8>;
 		spi-rx-bus-width = <8>;
@@ -451,14 +451,14 @@
 				reg = <0x6c0000 0x40000>;
 			};
 
-			partition@2000000 {
+			partition@800000 {
 				label = "ospi_nand.rootfs";
-				reg = <0x2000000 0x5fc0000>;
+				reg = <0x800000 0x37c0000>;
 			};
 
-			partition@7fc0000 {
+			partition@3fc0000 {
 				label = "ospi_nand.phypattern";
-				reg = <0x7fc0000 0x40000>;
+				reg = <0x3fc0000 0x40000>;
 			};
 		};
 	};
diff --git a/configs/am62ax_evm_a53_defconfig b/configs/am62ax_evm_a53_defconfig
index 5442796a82e7..bbb1c01d71f4 100644
--- a/configs/am62ax_evm_a53_defconfig
+++ b/configs/am62ax_evm_a53_defconfig
@@ -48,8 +48,9 @@ CONFIG_SPL_DM_MAILBOX=y
 CONFIG_SPL_MTD_SUPPORT=y
 CONFIG_SPL_MTD_LOAD=y
 CONFIG_SYS_MTD_U_BOOT_OFFS=0x280000
-CONFIG_SPL_NAND_SPI_SUPPORT=y
 CONFIG_SPL_DM_SPI_FLASH=y
+CONFIG_SPL_SPI_FLASH_SUPPORT=y
+CONFIG_SPL_SPI_SUPPORT=y
 CONFIG_SPL_POWER_DOMAIN=y
 CONFIG_SPL_RAM_SUPPORT=y
 CONFIG_SPL_USB_GADGET=y
@@ -117,8 +118,14 @@ CONFIG_SPL_MMC_SDHCI_ADMA=y
 CONFIG_MMC_SDHCI_AM654=y
 CONFIG_MTD=y
 CONFIG_DM_MTD=y
-CONFIG_MTD_SPI_NAND=y
 CONFIG_DM_SPI_FLASH=y
+CONFIG_SPI_FLASH_SFDP_SUPPORT=y
+CONFIG_SPI_FLASH_SOFT_RESET=y
+CONFIG_SPI_FLASH_SOFT_RESET_ON_BOOT=y
+CONFIG_SPI_FLASH_SPANSION=y
+CONFIG_SPI_FLASH_S28HX_T=y
+CONFIG_SPI_FLASH_STMICRO=y
+CONFIG_SPI_FLASH_MT35XU=y
 CONFIG_PHY_TI_DP83867=y
 CONFIG_TI_AM65_CPSW_NUSS=y
 CONFIG_PINCTRL=y
diff --git a/configs/am62ax_evm_r5_defconfig b/configs/am62ax_evm_r5_defconfig
index 156d5a188096..7ee8724b672a 100644
--- a/configs/am62ax_evm_r5_defconfig
+++ b/configs/am62ax_evm_r5_defconfig
@@ -12,6 +12,10 @@ CONFIG_CUSTOM_SYS_INIT_SP_ADDR=0x43c3a7f0
 CONFIG_ENV_SIZE=0x20000
 CONFIG_ENV_OFFSET=0x680000
 CONFIG_SPL_DM_SPI=y
+CONFIG_SPI=y
+CONFIG_DM_SPI=y
+CONFIG_CADENCE_QSPI=y
+CONFIG_CADENCE_QSPI_PHY=y
 CONFIG_DEFAULT_DEVICE_TREE="k3-am62a7-r5-sk"
 CONFIG_SPL_TEXT_BASE=0x43c00000
 CONFIG_DM_RESET=y
@@ -50,8 +54,12 @@ CONFIG_SPL_DMA=y
 CONFIG_SPL_DM_MAILBOX=y
 CONFIG_SPL_MTD_SUPPORT=y
 CONFIG_SPL_MTD_LOAD=y
-CONFIG_SPL_NAND_SPI_SUPPORT=y
+# CONFIG_SPL_NAND_SPI_SUPPORT=y
 CONFIG_SPL_DM_SPI_FLASH=y
+CONFIG_SPL_SPI_FLASH_SUPPORT=y
+CONFIG_SPL_SPI_SUPPORT=y
+CONFIG_SPL_SPI_FLASH_SFDP_SUPPORT=y
+CONFIG_SPL_SPI_LOAD=y
 CONFIG_SPL_DM_RESET=y
 CONFIG_SPL_POWER_DOMAIN=y
 CONFIG_SPL_RAM_SUPPORT=y
@@ -103,8 +111,15 @@ CONFIG_MMC_SDHCI_ADMA=y
 CONFIG_MMC_SDHCI_AM654=y
 CONFIG_MTD=y
 CONFIG_DM_MTD=y
-CONFIG_MTD_SPI_NAND=y
 CONFIG_DM_SPI_FLASH=y
+CONFIG_SF_DEFAULT_MODE=0
+CONFIG_SPI_FLASH_SFDP_SUPPORT=y
+CONFIG_SPI_FLASH_SOFT_RESET=y
+CONFIG_SPI_FLASH_SOFT_RESET_ON_BOOT=y
+CONFIG_SPI_FLASH_SPANSION=y
+CONFIG_SPI_FLASH_S28HX_T=y
+CONFIG_SPI_FLASH_STMICRO=y
+CONFIG_SPI_FLASH_MT35XU=y
 CONFIG_PINCTRL=y
 # CONFIG_PINCTRL_GENERIC is not set
 CONFIG_SPL_PINCTRL=y

base-commit: 7d050099177240f6cdf8992310f2cf4941e954af
prerequisite-patch-id: 26f3054c6516aae6a335c354a876ab1690a42de1
-- 
2.34.1

